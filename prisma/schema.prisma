generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
}

enum ScheduleCheckStatus {
  completed
  skipped
}

enum ReminderFrequency {
  daily
  weekly
  monthly
}

model User {
  id               BigInt               @id @default(autoincrement()) @db.UnsignedBigInt
  email            String               @unique(map: "idx_users_email") @db.VarChar(255)
  name             String               @db.VarChar(100)
  avatarUrl        String?              @map("avatar_url") @db.VarChar(500)
  createdAt        DateTime             @map("created_at")
  updatedAt        DateTime             @map("updated_at")
  deletedAt        DateTime?            @map("deleted_at")
  exercises        Exercise[]
  workoutMenus     WorkoutMenu[]
  workoutRecords   WorkoutSession[]
  weightRecords    WeightRecord[]
  weekSchedules    WeekSchedule[]
  scheduleChecks   ScheduleCheckRecord[]
  scheduleReminders ScheduleReminder[]

  @@index([deletedAt], map: "idx_users_deleted_at")
  @@map("users")
}

model BodyPart {
  id            BigInt             @id @default(autoincrement()) @db.UnsignedBigInt
  name          String             @db.VarChar(50)
  nameEn        String             @map("name_en") @db.VarChar(50)
  displayOrder  Int                @map("display_order") @db.UnsignedInt
  createdAt     DateTime           @map("created_at")
  updatedAt     DateTime           @map("updated_at")
  exercises     ExerciseBodyPart[]

  @@index([displayOrder], map: "idx_body_parts_display_order")
  @@map("body_parts")
}

model Exercise {
  id             BigInt             @id @default(autoincrement()) @db.UnsignedBigInt
  userId         BigInt             @map("user_id") @db.UnsignedBigInt
  name           String             @db.VarChar(100)
  formNote       String?            @map("form_note") @db.Text
  videoUrl       String?            @map("video_url") @db.VarChar(500)
  createdAt      DateTime           @map("created_at")
  updatedAt      DateTime           @map("updated_at")
  deletedAt      DateTime?          @map("deleted_at")
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  bodyParts      ExerciseBodyPart[]
  exerciseRecords ExerciseRecord[]
  menuExercises  MenuExercise[]

  @@index([userId], map: "idx_exercises_user_id")
  @@index([userId, deletedAt], map: "idx_exercises_user_id_deleted_at")
  @@map("exercises")
}

model ExerciseBodyPart {
  exerciseId BigInt   @map("exercise_id") @db.UnsignedBigInt
  bodyPartId BigInt   @map("body_part_id") @db.UnsignedBigInt
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  bodyPart   BodyPart @relation(fields: [bodyPartId], references: [id], onDelete: Restrict)

  @@id([exerciseId, bodyPartId])
  @@index([exerciseId], map: "idx_exercise_body_parts_exercise_id")
  @@index([bodyPartId], map: "idx_exercise_body_parts_body_part_id")
  @@map("exercise_body_parts")
}

model WorkoutMenu {
  id            BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  userId        BigInt          @map("user_id") @db.UnsignedBigInt
  name          String          @db.VarChar(100)
  createdAt     DateTime        @map("created_at")
  updatedAt     DateTime        @map("updated_at")
  deletedAt     DateTime?       @map("deleted_at")
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  menuExercises MenuExercise[]
  workoutRecords WorkoutSession[]
  weekSchedules WeekSchedule[]

  @@index([userId], map: "idx_workout_menus_user_id")
  @@index([userId, deletedAt], map: "idx_workout_menus_user_id_deleted_at")
  @@map("workout_menus")
}

model MenuExercise {
  id           BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  menuId       BigInt       @map("menu_id") @db.UnsignedBigInt
  exerciseId   BigInt       @map("exercise_id") @db.UnsignedBigInt
  displayOrder Int          @map("display_order") @db.UnsignedInt
  createdAt    DateTime     @map("created_at")
  updatedAt    DateTime     @map("updated_at")
  menu         WorkoutMenu  @relation(fields: [menuId], references: [id], onDelete: Cascade)
  exercise     Exercise     @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([menuId], map: "idx_menu_exercises_menu_id")
  @@index([menuId, displayOrder], map: "idx_menu_exercises_menu_id_display_order")
  @@unique([menuId, exerciseId], map: "uk_menu_exercises_menu_id_exercise_id")
  @@map("menu_exercises")
}

model WorkoutSession {
  id         BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  userId     BigInt       @map("user_id") @db.UnsignedBigInt
  menuId     BigInt       @map("menu_id") @db.UnsignedBigInt
  startedAt  DateTime     @map("started_at")
  endedAt    DateTime?    @map("ended_at")
  condition  Int          @map("condition_score") @db.UnsignedTinyInt
  fatigue    Int          @db.UnsignedTinyInt
  note       String       @db.Text
  createdAt  DateTime     @map("created_at")
  updatedAt  DateTime     @map("updated_at")
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  menu       WorkoutMenu  @relation(fields: [menuId], references: [id], onDelete: Restrict)
  exerciseRecords ExerciseRecord[]

  @@index([userId], map: "idx_workout_records_user_id")
  @@index([userId, startedAt], map: "idx_workout_records_user_id_started_at")
  @@index([menuId], map: "idx_workout_records_menu_id")
  @@map("workout_records")
}

model ExerciseRecord {
  id          BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  sessionId   BigInt       @map("session_id") @db.UnsignedBigInt
  exerciseId  BigInt       @map("exercise_id") @db.UnsignedBigInt
  createdAt   DateTime     @map("created_at")
  updatedAt   DateTime     @map("updated_at")
  session     WorkoutSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exercise    Exercise     @relation(fields: [exerciseId], references: [id], onDelete: Restrict)
  workoutSets WorkoutSet[]

  @@index([sessionId], map: "idx_exercise_records_session_id")
  @@index([exerciseId], map: "idx_exercise_records_exercise_id")
  @@map("exercise_records")
}

model WorkoutSet {
  id              BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  exerciseRecordId BigInt      @map("exercise_record_id") @db.UnsignedBigInt
  setNumber       Int          @map("set_number") @db.UnsignedInt
  weight          Decimal      @db.Decimal(5, 1)
  reps            Int          @db.UnsignedInt
  completed       Boolean      @db.TinyInt
  createdAt       DateTime     @map("created_at")
  updatedAt       DateTime     @map("updated_at")
  exerciseRecord  ExerciseRecord @relation(fields: [exerciseRecordId], references: [id], onDelete: Cascade)

  @@index([exerciseRecordId], map: "idx_workout_set_records_exercise_record_id")
  @@index([exerciseRecordId, setNumber], map: "idx_workout_set_records_exercise_record_id_set_number")
  @@map("workout_set_records")
}

model WeightRecord {
  id         BigInt     @id @default(autoincrement()) @db.UnsignedBigInt
  userId     BigInt     @map("user_id") @db.UnsignedBigInt
  recordedAt DateTime   @map("recorded_at")
  weight     Decimal    @db.Decimal(5, 1)
  createdAt  DateTime   @map("created_at")
  updatedAt  DateTime   @map("updated_at")
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_weight_records_user_id")
  @@index([userId, recordedAt], map: "idx_weight_records_user_id_recorded_at")
  @@map("weight_records")
}

model WeekSchedule {
  id              BigInt              @id @default(autoincrement()) @db.UnsignedBigInt
  userId          BigInt              @map("user_id") @db.UnsignedBigInt
  dayOfWeek       Int                 @map("day_of_week") @db.UnsignedTinyInt
  menuId          BigInt              @map("menu_id") @db.UnsignedBigInt
  createdAt       DateTime            @map("created_at")
  updatedAt       DateTime            @map("updated_at")
  deletedAt       DateTime?           @map("deleted_at")
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  menu            WorkoutMenu         @relation(fields: [menuId], references: [id], onDelete: Restrict)
  scheduleChecks  ScheduleCheckRecord[]
  scheduleReminders ScheduleReminder[]

  @@index([userId], map: "idx_week_schedules_user_id")
  @@index([userId, dayOfWeek], map: "idx_week_schedules_user_id_day_of_week")
  @@index([userId, deletedAt], map: "idx_week_schedules_user_id_deleted_at")
  @@unique([userId, dayOfWeek], map: "uk_week_schedules_user_id_day_of_week")
  @@map("week_schedules")
}

model ScheduleCheckRecord {
  id             BigInt            @id @default(autoincrement()) @db.UnsignedBigInt
  userId         BigInt            @map("user_id") @db.UnsignedBigInt
  weekScheduleId BigInt            @map("week_schedule_id") @db.UnsignedBigInt
  scheduledDate  DateTime          @map("scheduled_date") @db.Date
  status         ScheduleCheckStatus
  checkedAt      DateTime          @map("checked_at")
  createdAt      DateTime          @map("created_at")
  updatedAt      DateTime          @map("updated_at")
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  weekSchedule   WeekSchedule       @relation(fields: [weekScheduleId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_schedule_check_records_user_id")
  @@index([userId, scheduledDate], map: "idx_schedule_check_records_user_id_scheduled_date")
  @@index([weekScheduleId], map: "idx_schedule_check_records_week_schedule_id")
  @@unique([userId, weekScheduleId, scheduledDate], map: "uk_schedule_check_records_user_schedule_date")
  @@map("schedule_check_records")
}

model ScheduleReminder {
  id             BigInt           @id @default(autoincrement()) @db.UnsignedBigInt
  userId         BigInt           @map("user_id") @db.UnsignedBigInt
  weekScheduleId BigInt           @map("week_schedule_id") @db.UnsignedBigInt
  frequency      ReminderFrequency
  timeOfDay      DateTime         @map("time_of_day") @db.Time(0)
  dayOfWeek      Int?             @map("day_of_week") @db.UnsignedTinyInt
  dayOfMonth     Int?             @map("day_of_month") @db.UnsignedTinyInt
  startDate      DateTime         @map("start_date") @db.Date
  endDate        DateTime?        @map("end_date") @db.Date
  timezone       String           @db.VarChar(64)
  nextFireAt     DateTime         @map("next_fire_at")
  lastFiredAt    DateTime?        @map("last_fired_at")
  isEnabled      Boolean          @map("is_enabled") @db.TinyInt
  createdAt      DateTime         @map("created_at")
  updatedAt      DateTime         @map("updated_at")
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  weekSchedule   WeekSchedule     @relation(fields: [weekScheduleId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_schedule_reminders_user_id")
  @@index([userId, nextFireAt], map: "idx_schedule_reminders_user_id_next_fire_at")
  @@index([weekScheduleId], map: "idx_schedule_reminders_week_schedule_id")
  @@unique([userId, weekScheduleId], map: "uk_schedule_reminders_user_id_week_schedule_id")
  @@map("schedule_reminders")
}
