generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
}

enum ReminderFrequency {
  daily
  weekly
  monthly
}

enum RoutineType {
  weekly
  interval
}

enum DailyScheduleStatus {
  pending
  completed
  skipped
  rescheduled
}

// ========================================
// スケジュール機能用 Enum
// ========================================

enum ScheduleRuleType {
  weekly
  interval
  once
}

enum ScheduledTaskStatus {
  pending
  completed
  skipped
  rescheduled
}

enum ReminderType {
  before_scheduled
  fixed_time
}

model User {
  id               BigInt               @id @default(autoincrement()) @db.UnsignedBigInt
  email            String               @unique(map: "idx_users_email") @db.VarChar(255)
  name             String               @db.VarChar(100)
  avatarUrl        String?              @map("avatar_url") @db.VarChar(500)
  createdAt        DateTime             @default(now()) @map("created_at")
  updatedAt        DateTime             @updatedAt @map("updated_at")
  deletedAt        DateTime?            @map("deleted_at")
  exercises        Exercise[]
  workoutTemplates WorkoutTemplate[]
  workoutRecords   WorkoutRecord[]
  weightRecords    WeightRecord[]

  // スケジュール機能
  workoutSessions   WorkoutSession[]
  scheduleRules     ScheduleRule[]
  scheduledTasks    ScheduledTask[]
  scheduleReminders ScheduleReminder[]

  @@index([deletedAt], map: "idx_users_deleted_at")
  @@map("users")
}

model BodyPart {
  id            BigInt             @id @default(autoincrement()) @db.UnsignedBigInt
  name          String             @db.VarChar(50)
  nameEn        String             @map("name_en") @db.VarChar(50)
  displayOrder  Int                @map("display_order") @db.UnsignedInt
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  exercises     ExerciseBodyPart[]

  @@index([displayOrder], map: "idx_body_parts_display_order")
  @@map("body_parts")
}

model Exercise {
  id             BigInt             @id @default(autoincrement()) @db.UnsignedBigInt
  userId         BigInt             @map("user_id") @db.UnsignedBigInt
  name           String             @db.VarChar(100)
  formNote       String?            @map("form_note") @db.Text
  videoUrl       String?            @map("video_url") @db.VarChar(500)
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")
  deletedAt      DateTime?          @map("deleted_at")
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  bodyParts      ExerciseBodyPart[]
  workoutRecordExercises WorkoutRecordExercise[]
  workoutTemplateExercises  WorkoutTemplateExercise[]
  workoutSessionExercises WorkoutSessionExercise[]

  @@index([userId], map: "idx_exercises_user_id")
  @@index([userId, deletedAt], map: "idx_exercises_user_id_deleted_at")
  @@map("exercises")
}

model ExerciseBodyPart {
  exerciseId BigInt   @map("exercise_id") @db.UnsignedBigInt
  bodyPartId BigInt   @map("body_part_id") @db.UnsignedBigInt
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  bodyPart   BodyPart @relation(fields: [bodyPartId], references: [id], onDelete: Restrict)

  @@id([exerciseId, bodyPartId])
  @@index([bodyPartId], map: "idx_exercise_body_parts_body_part_id")
  @@map("exercise_body_parts")
}

model WorkoutTemplate {
  id            BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  userId        BigInt          @map("user_id") @db.UnsignedBigInt
  name          String          @db.VarChar(100)
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  deletedAt     DateTime?       @map("deleted_at")
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutTemplateExercises WorkoutTemplateExercise[]
  workoutRecords WorkoutRecord[]
  workoutSessions  WorkoutSession[]

  @@index([userId], map: "idx_workout_templates_user_id")
  @@index([userId, deletedAt], map: "idx_workout_templates_user_id_deleted_at")
  @@map("workout_templates")
}

model WorkoutTemplateExercise {
  id           BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  templateId   BigInt       @map("template_id") @db.UnsignedBigInt
  exerciseId   BigInt       @map("exercise_id") @db.UnsignedBigInt
  displayOrder Int          @map("display_order") @db.UnsignedInt
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  template     WorkoutTemplate  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  exercise     Exercise     @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([templateId], map: "idx_workout_template_exercises_template_id")
  @@index([templateId, displayOrder], map: "idx_workout_template_exercises_template_id_display_order")
  @@unique([templateId, exerciseId], map: "uk_workout_template_exercises_template_id_exercise_id")
  @@map("workout_template_exercises")
}

model WorkoutRecord {
  id              BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  userId          BigInt          @map("user_id") @db.UnsignedBigInt
  templateId      BigInt          @map("template_id") @db.UnsignedBigInt
  workoutSessionId BigInt?        @map("workout_session_id") @db.UnsignedBigInt
  scheduledTaskId BigInt?         @unique @map("scheduled_task_id") @db.UnsignedBigInt
  startedAt       DateTime        @map("started_at")
  endedAt         DateTime?       @map("ended_at")
  condition       Int             @map("condition_score") @db.UnsignedTinyInt
  fatigue         Int             @db.UnsignedTinyInt
  note            String          @db.Text
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  template        WorkoutTemplate @relation(fields: [templateId], references: [id], onDelete: Restrict)
  workoutSession  WorkoutSession? @relation(fields: [workoutSessionId], references: [id], onDelete: SetNull)
  scheduledTask   ScheduledTask?  @relation(fields: [scheduledTaskId], references: [id], onDelete: SetNull)
  workoutRecordExercises WorkoutRecordExercise[]

  @@index([userId], map: "idx_workout_records_user_id")
  @@index([userId, startedAt], map: "idx_workout_records_user_id_started_at")
  @@index([templateId], map: "idx_workout_records_template_id")
  @@index([workoutSessionId], map: "idx_workout_records_workout_session_id")
  @@map("workout_records")
}

model WorkoutRecordExercise {
  id          BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  recordId    BigInt       @map("record_id") @db.UnsignedBigInt
  exerciseId  BigInt       @map("exercise_id") @db.UnsignedBigInt
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  record      WorkoutRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  exercise    Exercise     @relation(fields: [exerciseId], references: [id], onDelete: Restrict)
  workoutRecordSets WorkoutRecordSet[]

  @@index([recordId], map: "idx_workout_record_exercises_record_id")
  @@index([exerciseId], map: "idx_workout_record_exercises_exercise_id")
  @@map("workout_record_exercises")
}

model WorkoutRecordSet {
  id              BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  workoutRecordExerciseId BigInt @map("workout_record_exercise_id") @db.UnsignedBigInt
  setNumber       Int          @map("set_number") @db.UnsignedInt
  weight          Decimal      @db.Decimal(5, 1)
  reps            Int          @db.UnsignedInt
  completed       Boolean      @db.TinyInt
  note            String?      @db.Text
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  workoutRecordExercise  WorkoutRecordExercise @relation(fields: [workoutRecordExerciseId], references: [id], onDelete: Cascade)

  @@index([workoutRecordExerciseId], map: "idx_workout_record_sets_workout_record_exercise_id")
  @@index([workoutRecordExerciseId, setNumber], map: "idx_workout_record_sets_workout_record_exercise_id_set_number")
  @@map("workout_record_sets")
}

model WeightRecord {
  id         BigInt     @id @default(autoincrement()) @db.UnsignedBigInt
  userId     BigInt     @map("user_id") @db.UnsignedBigInt
  recordedAt DateTime   @map("recorded_at")
  weight     Decimal    @db.Decimal(5, 1)
  bodyFat    Decimal?   @map("body_fat") @db.Decimal(4, 1)
  photoUrl   String?    @map("photo_url") @db.VarChar(500)
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_weight_records_user_id")
  @@index([userId, recordedAt], map: "idx_weight_records_user_id_recorded_at")
  @@map("weight_records")
}

// ========================================
// スケジュール機能（WorkoutSession ベース）
// ========================================

model WorkoutSession {
  id          BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  userId      BigInt    @map("user_id") @db.UnsignedBigInt
  templateId  BigInt    @map("template_id") @db.UnsignedBigInt
  name        String    @db.VarChar(100)
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  template        WorkoutTemplate       @relation(fields: [templateId], references: [id], onDelete: Restrict)
  exercises       WorkoutSessionExercise[]
  scheduleRules   ScheduleRule[]
  scheduledTasks  ScheduledTask[]
  reminders       ScheduleReminder[]
  workoutRecords  WorkoutRecord[]

  @@index([userId], map: "idx_workout_sessions_user_id")
  @@index([userId, deletedAt], map: "idx_workout_sessions_user_deleted")
  @@index([templateId], map: "idx_workout_sessions_template_id")
  @@map("workout_sessions")
}

model WorkoutSessionExercise {
  id            BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  workoutSessionId BigInt @map("workout_session_id") @db.UnsignedBigInt
  exerciseId    BigInt   @map("exercise_id") @db.UnsignedBigInt
  displayOrder  Int      @map("display_order") @db.UnsignedInt
  targetWeight  Decimal? @map("target_weight") @db.Decimal(5, 1)
  targetReps    Int?     @map("target_reps") @db.UnsignedInt
  targetSets    Int?     @map("target_sets") @db.UnsignedInt
  restSeconds   Int?     @map("rest_seconds") @db.UnsignedSmallInt
  note          String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  workoutSession WorkoutSession @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  exercise    Exercise    @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([workoutSessionId, exerciseId], map: "uk_workout_session_exercises_session_exercise")
  @@index([workoutSessionId], map: "idx_workout_session_exercises_workout_session_id")
  @@map("workout_session_exercises")
}

model ScheduleRule {
  id            BigInt           @id @default(autoincrement()) @db.UnsignedBigInt
  userId        BigInt           @map("user_id") @db.UnsignedBigInt
  workoutSessionId BigInt        @map("workout_session_id") @db.UnsignedBigInt
  ruleType      ScheduleRuleType @map("rule_type")

  // weekly用: ビットマスク (日=1, 月=2, 火=4, 水=8, 木=16, 金=32, 土=64)
  weekdays     Int?      @db.UnsignedTinyInt

  // interval用
  intervalDays Int?      @map("interval_days") @db.UnsignedSmallInt

  // interval/once共通: 開始日
  startDate    DateTime? @map("start_date") @db.Date

  // 終了日（任意: 期間限定ルール対応）
  endDate      DateTime? @map("end_date") @db.Date

  isEnabled Boolean   @default(true) @map("is_enabled") @db.TinyInt
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutSession WorkoutSession  @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  scheduledTasks ScheduledTask[]

  @@index([userId], map: "idx_schedule_rules_user_id")
  @@index([userId, deletedAt], map: "idx_schedule_rules_user_deleted")
  @@index([workoutSessionId], map: "idx_schedule_rules_workout_session_id")
  @@map("schedule_rules")
}

model ScheduledTask {
  id            BigInt              @id @default(autoincrement()) @db.UnsignedBigInt
  userId        BigInt              @map("user_id") @db.UnsignedBigInt
  ruleId        BigInt?             @map("rule_id") @db.UnsignedBigInt
  workoutSessionId BigInt           @map("workout_session_id") @db.UnsignedBigInt
  scheduledDate DateTime            @map("scheduled_date") @db.Date
  status        ScheduledTaskStatus @default(pending)

  // 振替追跡
  rescheduledTo   DateTime? @map("rescheduled_to") @db.Date
  rescheduledFrom DateTime? @map("rescheduled_from") @db.Date

  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  rule           ScheduleRule?   @relation(fields: [ruleId], references: [id], onDelete: SetNull)
  workoutSession WorkoutSession  @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)
  workoutRecord  WorkoutRecord?

  @@unique([userId, workoutSessionId, scheduledDate], map: "uk_scheduled_tasks_user_session_date")
  @@index([userId, scheduledDate], map: "idx_scheduled_tasks_user_date")
  @@index([ruleId], map: "idx_scheduled_tasks_rule_id")
  @@index([workoutSessionId], map: "idx_scheduled_tasks_workout_session_id")
  @@map("scheduled_tasks")
}

model ScheduleReminder {
  id             BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  userId         BigInt       @map("user_id") @db.UnsignedBigInt
  workoutSessionId BigInt     @map("workout_session_id") @db.UnsignedBigInt
  reminderType   ReminderType @map("reminder_type")
  offsetMinutes  Int?         @map("offset_minutes") @db.UnsignedSmallInt
  fixedTimeOfDay DateTime?    @map("fixed_time_of_day") @db.Time(0)
  timezone       String       @db.VarChar(64)
  isEnabled      Boolean      @default(true) @map("is_enabled") @db.TinyInt
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  user        User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutSession WorkoutSession @relation(fields: [workoutSessionId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_schedule_reminders_user_id")
  @@index([workoutSessionId], map: "idx_schedule_reminders_workout_session_id")
  @@map("schedule_reminders")
}
