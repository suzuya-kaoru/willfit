generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
}

enum ReminderFrequency {
  daily
  weekly
  monthly
}

enum RoutineType {
  weekly
  interval
}

enum DailyScheduleStatus {
  pending
  completed
  skipped
  rescheduled
}

// ========================================
// 新スケジュール機能用 Enum
// ========================================

enum ScheduleRuleType {
  weekly
  interval
  once
}

enum ScheduledTaskStatus {
  pending
  completed
  skipped
  rescheduled
}

enum ReminderType {
  before_scheduled
  fixed_time
}

model User {
  id               BigInt               @id @default(autoincrement()) @db.UnsignedBigInt
  email            String               @unique(map: "idx_users_email") @db.VarChar(255)
  name             String               @db.VarChar(100)
  avatarUrl        String?              @map("avatar_url") @db.VarChar(500)
  createdAt        DateTime             @default(now()) @map("created_at")
  updatedAt        DateTime             @updatedAt @map("updated_at")
  deletedAt        DateTime?            @map("deleted_at")
  exercises        Exercise[]
  workoutMenus     WorkoutMenu[]
  workoutRecords   WorkoutRecord[]
  weightRecords    WeightRecord[]


  // 新スケジュール機能
  sessionPlans      SessionPlan[]
  scheduleRules     ScheduleRule[]
  scheduledTasks    ScheduledTask[]
  scheduleReminders ScheduleReminder[]

  @@index([deletedAt], map: "idx_users_deleted_at")
  @@map("users")
}

model BodyPart {
  id            BigInt             @id @default(autoincrement()) @db.UnsignedBigInt
  name          String             @db.VarChar(50)
  nameEn        String             @map("name_en") @db.VarChar(50)
  displayOrder  Int                @map("display_order") @db.UnsignedInt
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  exercises     ExerciseBodyPart[]

  @@index([displayOrder], map: "idx_body_parts_display_order")
  @@map("body_parts")
}

model Exercise {
  id             BigInt             @id @default(autoincrement()) @db.UnsignedBigInt
  userId         BigInt             @map("user_id") @db.UnsignedBigInt
  name           String             @db.VarChar(100)
  formNote       String?            @map("form_note") @db.Text
  videoUrl       String?            @map("video_url") @db.VarChar(500)
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")
  deletedAt      DateTime?          @map("deleted_at")
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  bodyParts      ExerciseBodyPart[]
  exerciseRecords ExerciseRecord[]
  menuExercises  MenuExercise[]
  sessionPlanExercises SessionPlanExercise[]

  @@index([userId], map: "idx_exercises_user_id")
  @@index([userId, deletedAt], map: "idx_exercises_user_id_deleted_at")
  @@map("exercises")
}

model ExerciseBodyPart {
  exerciseId BigInt   @map("exercise_id") @db.UnsignedBigInt
  bodyPartId BigInt   @map("body_part_id") @db.UnsignedBigInt
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  bodyPart   BodyPart @relation(fields: [bodyPartId], references: [id], onDelete: Restrict)

  @@id([exerciseId, bodyPartId])
  @@index([bodyPartId], map: "idx_exercise_body_parts_body_part_id")
  @@map("exercise_body_parts")
}

model WorkoutMenu {
  id            BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  userId        BigInt          @map("user_id") @db.UnsignedBigInt
  name          String          @db.VarChar(100)
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  deletedAt     DateTime?       @map("deleted_at")
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  menuExercises MenuExercise[]
  workoutRecords WorkoutRecord[]

  sessionPlans  SessionPlan[]

  @@index([userId], map: "idx_workout_menus_user_id")
  @@index([userId, deletedAt], map: "idx_workout_menus_user_id_deleted_at")
  @@map("workout_menus")
}

model MenuExercise {
  id           BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  menuId       BigInt       @map("menu_id") @db.UnsignedBigInt
  exerciseId   BigInt       @map("exercise_id") @db.UnsignedBigInt
  displayOrder Int          @map("display_order") @db.UnsignedInt
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  menu         WorkoutMenu  @relation(fields: [menuId], references: [id], onDelete: Cascade)
  exercise     Exercise     @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([menuId], map: "idx_menu_exercises_menu_id")
  @@index([menuId, displayOrder], map: "idx_menu_exercises_menu_id_display_order")
  @@unique([menuId, exerciseId], map: "uk_menu_exercises_menu_id_exercise_id")
  @@map("menu_exercises")
}

model WorkoutRecord {
  id              BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  userId          BigInt          @map("user_id") @db.UnsignedBigInt
  menuId          BigInt          @map("menu_id") @db.UnsignedBigInt
  sessionPlanId   BigInt?         @map("session_plan_id") @db.UnsignedBigInt
  scheduledTaskId BigInt?         @unique @map("scheduled_task_id") @db.UnsignedBigInt
  startedAt       DateTime        @map("started_at")
  endedAt         DateTime?       @map("ended_at")
  condition       Int             @map("condition_score") @db.UnsignedTinyInt
  fatigue         Int             @db.UnsignedTinyInt
  note            String          @db.Text
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  menu            WorkoutMenu     @relation(fields: [menuId], references: [id], onDelete: Restrict)
  sessionPlan     SessionPlan?    @relation(fields: [sessionPlanId], references: [id], onDelete: SetNull)
  scheduledTask   ScheduledTask?  @relation(fields: [scheduledTaskId], references: [id], onDelete: SetNull)
  exerciseRecords ExerciseRecord[]

  @@index([userId], map: "idx_workout_records_user_id")
  @@index([userId, startedAt], map: "idx_workout_records_user_id_started_at")
  @@index([menuId], map: "idx_workout_records_menu_id")
  @@index([sessionPlanId], map: "idx_workout_records_session_plan_id")
  @@map("workout_records")
}

model ExerciseRecord {
  id          BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  recordId    BigInt       @map("session_id") @db.UnsignedBigInt
  exerciseId  BigInt       @map("exercise_id") @db.UnsignedBigInt
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  record      WorkoutRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)
  exercise    Exercise     @relation(fields: [exerciseId], references: [id], onDelete: Restrict)
  workoutSets WorkoutSet[]

  @@index([recordId], map: "idx_exercise_records_session_id")
  @@index([exerciseId], map: "idx_exercise_records_exercise_id")
  @@map("exercise_records")
}

model WorkoutSet {
  id              BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  exerciseRecordId BigInt      @map("exercise_record_id") @db.UnsignedBigInt
  setNumber       Int          @map("set_number") @db.UnsignedInt
  weight          Decimal      @db.Decimal(5, 1)
  reps            Int          @db.UnsignedInt
  completed       Boolean      @db.TinyInt
  note            String?      @db.Text
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  exerciseRecord  ExerciseRecord @relation(fields: [exerciseRecordId], references: [id], onDelete: Cascade)

  @@index([exerciseRecordId], map: "idx_workout_set_records_exercise_record_id")
  @@index([exerciseRecordId, setNumber], map: "idx_workout_set_records_exercise_record_id_set_number")
  @@map("workout_set_records")
}

model WeightRecord {
  id         BigInt     @id @default(autoincrement()) @db.UnsignedBigInt
  userId     BigInt     @map("user_id") @db.UnsignedBigInt
  recordedAt DateTime   @map("recorded_at")
  weight     Decimal    @db.Decimal(5, 1)
  bodyFat    Decimal?   @map("body_fat") @db.Decimal(4, 1)
  photoUrl   String?    @map("photo_url") @db.VarChar(500)
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_weight_records_user_id")
  @@index([userId, recordedAt], map: "idx_weight_records_user_id_recorded_at")
  @@map("weight_records")
}

// ========================================
// ルーティンスケジュール機能
// ========================================



// ========================================
// 新スケジュール機能（SessionPlan ベース）
// ========================================

model SessionPlan {
  id          BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  userId      BigInt    @map("user_id") @db.UnsignedBigInt
  menuId      BigInt    @map("menu_id") @db.UnsignedBigInt
  name        String    @db.VarChar(100)
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")

  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  menu            WorkoutMenu           @relation(fields: [menuId], references: [id], onDelete: Restrict)
  exercises       SessionPlanExercise[]
  scheduleRules   ScheduleRule[]
  scheduledTasks  ScheduledTask[]
  reminders       ScheduleReminder[]
  workoutRecords WorkoutRecord[]

  @@index([userId], map: "idx_session_plans_user_id")
  @@index([userId, deletedAt], map: "idx_session_plans_user_deleted")
  @@index([menuId], map: "idx_session_plans_menu_id")
  @@map("session_plans")
}

model SessionPlanExercise {
  id            BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  sessionPlanId BigInt   @map("session_plan_id") @db.UnsignedBigInt
  exerciseId    BigInt   @map("exercise_id") @db.UnsignedBigInt
  displayOrder  Int      @map("display_order") @db.UnsignedInt
  targetWeight  Decimal? @map("target_weight") @db.Decimal(5, 1)
  targetReps    Int?     @map("target_reps") @db.UnsignedInt
  targetSets    Int?     @map("target_sets") @db.UnsignedInt
  restSeconds   Int?     @map("rest_seconds") @db.UnsignedSmallInt
  note          String?  @db.Text
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  sessionPlan SessionPlan @relation(fields: [sessionPlanId], references: [id], onDelete: Cascade)
  exercise    Exercise    @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([sessionPlanId, exerciseId], map: "uk_session_plan_exercises_plan_exercise")
  @@index([sessionPlanId], map: "idx_session_plan_exercises_plan_id")
  @@map("session_plan_exercises")
}

model ScheduleRule {
  id            BigInt           @id @default(autoincrement()) @db.UnsignedBigInt
  userId        BigInt           @map("user_id") @db.UnsignedBigInt
  sessionPlanId BigInt           @map("session_plan_id") @db.UnsignedBigInt
  ruleType      ScheduleRuleType @map("rule_type")

  // weekly用: ビットマスク (日=1, 月=2, 火=4, 水=8, 木=16, 金=32, 土=64)
  weekdays     Int?      @db.UnsignedTinyInt

  // interval用
  intervalDays Int?      @map("interval_days") @db.UnsignedSmallInt

  // interval/once共通: 開始日
  startDate    DateTime? @map("start_date") @db.Date

  // 終了日（任意: 期間限定ルール対応）
  endDate      DateTime? @map("end_date") @db.Date

  isEnabled Boolean   @default(true) @map("is_enabled") @db.TinyInt
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionPlan    SessionPlan     @relation(fields: [sessionPlanId], references: [id], onDelete: Cascade)
  scheduledTasks ScheduledTask[]

  @@index([userId], map: "idx_schedule_rules_user_id")
  @@index([userId, deletedAt], map: "idx_schedule_rules_user_deleted")
  @@index([sessionPlanId], map: "idx_schedule_rules_session_plan_id")
  @@map("schedule_rules")
}

model ScheduledTask {
  id            BigInt              @id @default(autoincrement()) @db.UnsignedBigInt
  userId        BigInt              @map("user_id") @db.UnsignedBigInt
  ruleId        BigInt?             @map("rule_id") @db.UnsignedBigInt
  sessionPlanId BigInt              @map("session_plan_id") @db.UnsignedBigInt
  scheduledDate DateTime            @map("scheduled_date") @db.Date
  status        ScheduledTaskStatus @default(pending)

  // 振替追跡
  rescheduledTo   DateTime? @map("rescheduled_to") @db.Date
  rescheduledFrom DateTime? @map("rescheduled_from") @db.Date

  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  rule           ScheduleRule?   @relation(fields: [ruleId], references: [id], onDelete: SetNull)
  sessionPlan    SessionPlan     @relation(fields: [sessionPlanId], references: [id], onDelete: Cascade)
  workoutRecord WorkoutRecord?

  @@unique([userId, sessionPlanId, scheduledDate], map: "uk_scheduled_tasks_user_plan_date")
  @@index([userId, scheduledDate], map: "idx_scheduled_tasks_user_date")
  @@index([ruleId], map: "idx_scheduled_tasks_rule_id")
  @@index([sessionPlanId], map: "idx_scheduled_tasks_session_plan_id")
  @@map("scheduled_tasks")
}

model ScheduleReminder {
  id             BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  userId         BigInt       @map("user_id") @db.UnsignedBigInt
  sessionPlanId  BigInt       @map("session_plan_id") @db.UnsignedBigInt
  reminderType   ReminderType @map("reminder_type")
  offsetMinutes  Int?         @map("offset_minutes") @db.UnsignedSmallInt
  fixedTimeOfDay DateTime?    @map("fixed_time_of_day") @db.Time(0)
  timezone       String       @db.VarChar(64)
  isEnabled      Boolean      @default(true) @map("is_enabled") @db.TinyInt
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessionPlan SessionPlan @relation(fields: [sessionPlanId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_schedule_reminders_user_id")
  @@index([sessionPlanId], map: "idx_schedule_reminders_session_plan_id")
  @@map("schedule_reminders")
}
