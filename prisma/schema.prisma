generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
}

enum ReminderFrequency {
  daily
  weekly
  monthly
}

enum RoutineType {
  weekly
  interval
}

enum DailyScheduleStatus {
  pending
  completed
  skipped
  rescheduled
}

model User {
  id               BigInt               @id @default(autoincrement()) @db.UnsignedBigInt
  email            String               @unique(map: "idx_users_email") @db.VarChar(255)
  name             String               @db.VarChar(100)
  avatarUrl        String?              @map("avatar_url") @db.VarChar(500)
  createdAt        DateTime             @default(now()) @map("created_at")
  updatedAt        DateTime             @updatedAt @map("updated_at")
  deletedAt        DateTime?            @map("deleted_at")
  exercises        Exercise[]
  workoutMenus     WorkoutMenu[]
  workoutRecords   WorkoutSession[]
  weightRecords    WeightRecord[]
  scheduleRoutines  ScheduleRoutine[]
  dailySchedules    DailySchedule[]
  routineReminders  ScheduleRoutineReminder[]

  @@index([deletedAt], map: "idx_users_deleted_at")
  @@map("users")
}

model BodyPart {
  id            BigInt             @id @default(autoincrement()) @db.UnsignedBigInt
  name          String             @db.VarChar(50)
  nameEn        String             @map("name_en") @db.VarChar(50)
  displayOrder  Int                @map("display_order") @db.UnsignedInt
  createdAt     DateTime           @default(now()) @map("created_at")
  updatedAt     DateTime           @updatedAt @map("updated_at")
  exercises     ExerciseBodyPart[]

  @@index([displayOrder], map: "idx_body_parts_display_order")
  @@map("body_parts")
}

model Exercise {
  id             BigInt             @id @default(autoincrement()) @db.UnsignedBigInt
  userId         BigInt             @map("user_id") @db.UnsignedBigInt
  name           String             @db.VarChar(100)
  formNote       String?            @map("form_note") @db.Text
  videoUrl       String?            @map("video_url") @db.VarChar(500)
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")
  deletedAt      DateTime?          @map("deleted_at")
  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  bodyParts      ExerciseBodyPart[]
  exerciseRecords ExerciseRecord[]
  menuExercises  MenuExercise[]

  @@index([userId], map: "idx_exercises_user_id")
  @@index([userId, deletedAt], map: "idx_exercises_user_id_deleted_at")
  @@map("exercises")
}

model ExerciseBodyPart {
  exerciseId BigInt   @map("exercise_id") @db.UnsignedBigInt
  bodyPartId BigInt   @map("body_part_id") @db.UnsignedBigInt
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  bodyPart   BodyPart @relation(fields: [bodyPartId], references: [id], onDelete: Restrict)

  @@id([exerciseId, bodyPartId])
  @@index([bodyPartId], map: "idx_exercise_body_parts_body_part_id")
  @@map("exercise_body_parts")
}

model WorkoutMenu {
  id            BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  userId        BigInt          @map("user_id") @db.UnsignedBigInt
  name          String          @db.VarChar(100)
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")
  deletedAt     DateTime?       @map("deleted_at")
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  menuExercises MenuExercise[]
  workoutRecords WorkoutSession[]
  scheduleRoutines ScheduleRoutine[]

  @@index([userId], map: "idx_workout_menus_user_id")
  @@index([userId, deletedAt], map: "idx_workout_menus_user_id_deleted_at")
  @@map("workout_menus")
}

model MenuExercise {
  id           BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  menuId       BigInt       @map("menu_id") @db.UnsignedBigInt
  exerciseId   BigInt       @map("exercise_id") @db.UnsignedBigInt
  displayOrder Int          @map("display_order") @db.UnsignedInt
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")
  menu         WorkoutMenu  @relation(fields: [menuId], references: [id], onDelete: Cascade)
  exercise     Exercise     @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@index([menuId], map: "idx_menu_exercises_menu_id")
  @@index([menuId, displayOrder], map: "idx_menu_exercises_menu_id_display_order")
  @@unique([menuId, exerciseId], map: "uk_menu_exercises_menu_id_exercise_id")
  @@map("menu_exercises")
}

model WorkoutSession {
  id         BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  userId     BigInt       @map("user_id") @db.UnsignedBigInt
  menuId     BigInt       @map("menu_id") @db.UnsignedBigInt
  startedAt  DateTime     @map("started_at")
  endedAt    DateTime?    @map("ended_at")
  condition  Int          @map("condition_score") @db.UnsignedTinyInt
  fatigue    Int          @db.UnsignedTinyInt
  note       String       @db.Text
  createdAt  DateTime     @default(now()) @map("created_at")
  updatedAt  DateTime     @updatedAt @map("updated_at")
  user       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  menu       WorkoutMenu  @relation(fields: [menuId], references: [id], onDelete: Restrict)
  exerciseRecords ExerciseRecord[]

  @@index([userId], map: "idx_workout_records_user_id")
  @@index([userId, startedAt], map: "idx_workout_records_user_id_started_at")
  @@index([menuId], map: "idx_workout_records_menu_id")
  @@map("workout_records")
}

model ExerciseRecord {
  id          BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  sessionId   BigInt       @map("session_id") @db.UnsignedBigInt
  exerciseId  BigInt       @map("exercise_id") @db.UnsignedBigInt
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")
  session     WorkoutSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exercise    Exercise     @relation(fields: [exerciseId], references: [id], onDelete: Restrict)
  workoutSets WorkoutSet[]

  @@index([sessionId], map: "idx_exercise_records_session_id")
  @@index([exerciseId], map: "idx_exercise_records_exercise_id")
  @@map("exercise_records")
}

model WorkoutSet {
  id              BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  exerciseRecordId BigInt      @map("exercise_record_id") @db.UnsignedBigInt
  setNumber       Int          @map("set_number") @db.UnsignedInt
  weight          Decimal      @db.Decimal(5, 1)
  reps            Int          @db.UnsignedInt
  completed       Boolean      @db.TinyInt
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  exerciseRecord  ExerciseRecord @relation(fields: [exerciseRecordId], references: [id], onDelete: Cascade)

  @@index([exerciseRecordId], map: "idx_workout_set_records_exercise_record_id")
  @@index([exerciseRecordId, setNumber], map: "idx_workout_set_records_exercise_record_id_set_number")
  @@map("workout_set_records")
}

model WeightRecord {
  id         BigInt     @id @default(autoincrement()) @db.UnsignedBigInt
  userId     BigInt     @map("user_id") @db.UnsignedBigInt
  recordedAt DateTime   @map("recorded_at")
  weight     Decimal    @db.Decimal(5, 1)
  bodyFat    Decimal?   @map("body_fat") @db.Decimal(4, 1)
  photoUrl   String?    @map("photo_url") @db.VarChar(500)
  createdAt  DateTime   @default(now()) @map("created_at")
  updatedAt  DateTime   @updatedAt @map("updated_at")
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_weight_records_user_id")
  @@index([userId, recordedAt], map: "idx_weight_records_user_id_recorded_at")
  @@map("weight_records")
}

// ========================================
// ルーティンスケジュール機能
// ========================================

model ScheduleRoutine {
  id           BigInt      @id @default(autoincrement()) @db.UnsignedBigInt
  userId       BigInt      @map("user_id") @db.UnsignedBigInt
  menuId       BigInt      @map("menu_id") @db.UnsignedBigInt
  routineType  RoutineType @map("routine_type")

  // weekly用: ビットマスク (日=1, 月=2, 火=4, 水=8, 木=16, 金=32, 土=64)
  weekdays     Int?        @db.UnsignedTinyInt

  // interval用
  intervalDays Int?        @map("interval_days") @db.UnsignedSmallInt
  startDate    DateTime?   @map("start_date") @db.Date

  isEnabled    Boolean     @default(true) @map("is_enabled") @db.TinyInt
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")
  deletedAt    DateTime?   @map("deleted_at")

  user           User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  menu           WorkoutMenu              @relation(fields: [menuId], references: [id], onDelete: Restrict)
  dailySchedules DailySchedule[]
  reminder       ScheduleRoutineReminder?

  @@unique([userId, menuId], map: "uk_schedule_routines_user_menu")
  @@index([userId], map: "idx_schedule_routines_user_id")
  @@index([userId, deletedAt], map: "idx_schedule_routines_user_deleted")
  @@map("schedule_routines")
}

model DailySchedule {
  id              BigInt              @id @default(autoincrement()) @db.UnsignedBigInt
  userId          BigInt              @map("user_id") @db.UnsignedBigInt
  routineId       BigInt              @map("routine_id") @db.UnsignedBigInt
  scheduledDate   DateTime            @map("scheduled_date") @db.Date
  status          DailyScheduleStatus @default(pending)

  // 振替追跡
  rescheduledTo   DateTime?           @map("rescheduled_to") @db.Date
  rescheduledFrom DateTime?           @map("rescheduled_from") @db.Date

  completedAt     DateTime?           @map("completed_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  routine ScheduleRoutine @relation(fields: [routineId], references: [id], onDelete: Cascade)

  @@unique([userId, routineId, scheduledDate], map: "uk_daily_schedules_user_routine_date")
  @@index([userId, scheduledDate], map: "idx_daily_schedules_user_date")
  @@map("daily_schedules")
}

model ScheduleRoutineReminder {
  id         BigInt            @id @default(autoincrement()) @db.UnsignedBigInt
  userId     BigInt            @map("user_id") @db.UnsignedBigInt
  routineId  BigInt            @unique @map("routine_id") @db.UnsignedBigInt
  frequency  ReminderFrequency
  timeOfDay  DateTime          @map("time_of_day") @db.Time(0)
  dayOfWeek  Int?              @map("day_of_week") @db.UnsignedTinyInt
  dayOfMonth Int?              @map("day_of_month") @db.UnsignedTinyInt
  startDate  DateTime          @map("start_date") @db.Date
  timezone   String            @db.VarChar(64)
  nextFireAt DateTime          @map("next_fire_at")
  isEnabled  Boolean           @default(true) @map("is_enabled") @db.TinyInt
  createdAt  DateTime          @default(now()) @map("created_at")
  updatedAt  DateTime          @updatedAt @map("updated_at")

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  routine ScheduleRoutine @relation(fields: [routineId], references: [id], onDelete: Cascade)

  @@index([userId], map: "idx_schedule_routine_reminders_user")
  @@map("schedule_routine_reminders")
}
