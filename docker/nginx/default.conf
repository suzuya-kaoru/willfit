server {
    listen 80;
    server_name myapp;

    # HTTP でのアクセスを HTTPS にリダイレクト
    return 301 https://$host$request_uri;
}

#################################################
# myapp.kaoru
#################################################
server {
    listen 443 ssl;
    ssl_certificate     /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;

    server_name myapp.kaoru;

    client_max_body_size 64M;

    gzip on;
    gzip_types *;
    gzip_proxied any;
    proxy_buffer_size 8k;

    # 静的ファイル
    location /next_img/ {
        root /var/www/my-fitness-app/public;
        access_log off;
        expires max;
        add_header Cache-Control "public, must-revalidate, proxy-revalidate";
    }

    # Next.jsの静的ファイル
    location ~ ^/_next/ {
        proxy_pass http://node:3000;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 3600s; # タイムアウト時間考慮
        proxy_send_timeout 3600s; # タイムアウト時間考慮
        proxy_read_timeout 3600s; # タイムアウト時間考慮
    }

    index  index.php index.html index.htm;
    root /var/www/my-fitness-app;

    # Add security headers
    add_header Strict-Transport-Security "max-age=63072000; preload";
    add_header X-XSS-Protection "1; mode=block";
    add_header X-Content-Type-Options "nosniff";
    add_header X-Frame-Options "SAMEORIGIN";


    etag off;

    location /mailpit {
        proxy_set_header Host $host;
        proxy_pass http://mailhog:8025;
    }

    location /adminer {
        proxy_set_header Host $host;
        proxy_pass http://adminer:8080;
    }

# APIやルートページ全部
    location / {
        proxy_pass http://node:3000;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-Proto https;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_connect_timeout 3600s; # タイムアウト時間考慮
        proxy_send_timeout 3600s; # タイムアウト時間考慮
        proxy_read_timeout 3600s; # タイムアウト時間考慮
    }
}
